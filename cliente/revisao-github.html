<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Revisar Pedido - Sistema de Pedidos</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
</head>
<body>
    <div class="container">
        <div class="header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: var(--radius-xl); margin-bottom: var(--spacing-lg);">
            <div style="display: flex; align-items: center; gap: var(--spacing-md);">
                <button onclick="voltar()" style="background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer;">â†</button>
                <div>
                    <h1 style="font-size: 1.25rem;">ğŸ“‹ Revisar Pedido</h1>
                    <p style="font-size: 0.875rem; opacity: 0.9;">Confirme os dados antes de enviar</p>
                </div>
            </div>
        </div>

        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>Carregando...</p>
        </div>

        <div id="conteudo" style="display: none;">
            <div class="card" style="margin-bottom: var(--spacing-lg);">
                <h3 style="margin-bottom: var(--spacing-md); display: flex; align-items: center; gap: var(--spacing-sm);">
                    ğŸ›’ Seu Pedido
                </h3>
                <div id="tipoPedidoBadge" style="display: inline-block; padding: var(--spacing-xs) var(--spacing-sm); background: var(--primary-600); border-radius: var(--radius-sm); font-size: 0.875rem; margin-bottom: var(--spacing-md);"></div>
                <div id="itensPedido"></div>
                <div style="border-top: 2px solid var(--border-light); margin-top: var(--spacing-md); padding-top: var(--spacing-md);">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-size: 1.125rem; font-weight: 600;">Total do Pedido</span>
                        <span style="font-size: 1.5rem; font-weight: 700; color: var(--success-600);" id="totalPedido">R$ 0,00</span>
                    </div>
                </div>
            </div>

            <div class="card" style="margin-bottom: var(--spacing-lg);">
                <h3 style="margin-bottom: var(--spacing-md); display: flex; align-items: center; gap: var(--spacing-sm);">
                    ğŸ‘¤ Cliente
                </h3>
                <p style="color: var(--text-primary); font-size: 1rem;" id="nomeCliente"></p>
                <p style="color: var(--text-secondary); font-size: 0.875rem;" id="telefoneCliente"></p>
            </div>

            <div class="card" id="enderecoCard" style="margin-bottom: var(--spacing-lg);">
                <h3 style="margin-bottom: var(--spacing-md); display: flex; align-items: center; gap: var(--spacing-sm);">
                    ğŸ“ EndereÃ§o de Entrega
                </h3>
                <div id="enderecoContainer">
                    <p style="color: var(--text-primary); font-size: 1rem; margin-bottom: var(--spacing-md);" id="enderecoTexto"></p>
                    <button class="btn btn-secondary" onclick="alterarEndereco()">
                        âœï¸ Alterar EndereÃ§o
                    </button>
                </div>
            </div>

            <div class="card" style="margin-bottom: var(--spacing-lg);">
                <h3 style="margin-bottom: var(--spacing-md); display: flex; align-items: center; gap: var(--spacing-sm);">
                    ğŸ’³ Forma de Pagamento
                </h3>
                <div class="form-group">
                    <select id="formaPagamento" class="pagamento-select" onchange="validarFormulario()">
                        <option value="">Selecione a forma de pagamento...</option>
                        <option value="dinheiro">ğŸ’µ Dinheiro</option>
                        <option value="pix">ğŸ“± PIX</option>
                        <option value="cartao_credito">ğŸ’³ CartÃ£o de CrÃ©dito</option>
                        <option value="cartao_debito">ğŸ’³ CartÃ£o de DÃ©bito</option>
                    </select>
                </div>
            </div>

            <div id="erroContainer" class="error-message" style="display: none; margin-bottom: var(--spacing-lg);"></div>

            <button class="btn btn-success" id="btnConfirmar" onclick="enviarPedido()" disabled style="margin-top: var(--spacing-lg);">
                âœ… Confirmar e Enviar Pedido
            </button>

            <button class="btn btn-secondary" onclick="voltar()" style="margin-top: var(--spacing-md);">
                â† Voltar aos Produtos
            </button>
        </div>
    </div>

    <div class="toast" id="toast" style="display: none;"></div>

    <script>
        const CLIENTE_KEY = 'sistema_pedidos_cliente';
        const CARRINHO_KEY = 'tocomfome_carrinho';
        const TIPO_PEDIDO_KEY = 'tocomfome_tipo_pedido';

        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyCh3E-Wu3OQZ8yZVxaRYdNNXVgmma4S8Jo",
            authDomain: "tocomfome-bbad8.firebaseapp.com",
            projectId: "tocomfome-bbad8",
            storageBucket: "tocomfome-bbad8.firebasestorage.app",
            messagingSenderId: "173195608514",
            appId: "1:173195608514:web:cf806076d52317bc58d65b"
        };

        let db = null;
        let app = null;
        let currentLojaId = null;
        let carrinho = [];
        let cliente = null;
        let tipoPedido = null;

        function getLojaId() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('lojaid');
        }

        function getCliente() {
            const dados = localStorage.getItem(CLIENTE_KEY);
            if (dados) {
                try { return JSON.parse(dados); } catch (e) { return null; }
            }
            return null;
        }

        function getCarrinho() {
            const dados = localStorage.getItem(CARRINHO_KEY);
            if (dados) {
                try { return JSON.parse(dados); } catch (e) { return []; }
            }
            return [];
        }

        function getTipoPedido() {
            return localStorage.getItem(TIPO_PEDIDO_KEY);
        }

        function formatarMoeda(valor) {
            return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(valor);
        }

        function showError(mensagem) {
            const erroContainer = document.getElementById('erroContainer');
            erroContainer.textContent = mensagem;
            erroContainer.style.display = 'block';
        }

        function hideError() {
            document.getElementById('erroContainer').style.display = 'none';
        }

        function showToast(mensagem, tipo = 'success') {
            const toast = document.getElementById('toast');
            if (toast) {
                toast.textContent = mensagem;
                toast.className = `toast ${tipo}`;
                toast.style.display = 'block';
                setTimeout(() => { toast.style.display = 'none'; }, 3000);
            }
        }

        async function initFirebase() {
            if (db) return db;
            try {
                app = firebase.initializeApp(FIREBASE_CONFIG);
                db = firebase.firestore();
                return db;
            } catch (error) {
                console.error('Firebase error:', error);
                return null;
            }
        }

        async function init() {
            currentLojaId = getLojaId();
            if (!currentLojaId) {
                showError('Loja nÃ£o configurada');
                return;
            }

            await initFirebase();

            cliente = getCliente();
            carrinho = getCarrinho();
            tipoPedido = getTipoPedido();

            if (!cliente) {
                window.location.href = `telefone-github.html?lojaid=${currentLojaId}`;
                return;
            }

            if (!carrinho || carrinho.length === 0) {
                window.location.href = `pedido-github.html?lojaid=${currentLojaId}`;
                return;
            }

            if (!tipoPedido) {
                window.location.href = `pedido-github.html?lojaid=${currentLojaId}`;
                return;
            }

            document.getElementById('nomeCliente').textContent = cliente.nome;
            document.getElementById('telefoneCliente').textContent = cliente.telefone;

            const enderecoCard = document.getElementById('enderecoCard');
            if (tipoPedido === 'entrega') {
                enderecoCard.style.display = 'block';
                document.getElementById('enderecoTexto').textContent = cliente.endereco || 'EndereÃ§o nÃ£o cadastrado';
            } else {
                enderecoCard.style.display = 'none';
            }

            document.getElementById('tipoPedidoBadge').textContent = tipoPedido === 'entrega' ? 'ğŸš— Delivery' : 'ğŸƒ Retirada';

            const itensContainer = document.getElementById('itensPedido');
            let total = 0;

            itensContainer.innerHTML = carrinho.map(item => {
                total += item.subtotal;
                return `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-sm);">
                        <div>
                            <div style="font-weight: 500;">${item.quantidade}x ${item.nome}</div>
                        </div>
                        <div style="color: var(--text-secondary);">${formatarMoeda(item.subtotal)}</div>
                    </div>
                `;
            }).join('');

            document.getElementById('totalPedido').textContent = formatarMoeda(total);

            document.getElementById('loading').style.display = 'none';
            document.getElementById('conteudo').style.display = 'block';
        }

        function validarFormulario() {
            const formaPagamento = document.getElementById('formaPagamento').value;
            const btnConfirmar = document.getElementById('btnConfirmar');

            if (formaPagamento) {
                btnConfirmar.disabled = false;
            } else {
                btnConfirmar.disabled = true;
            }
        }

        function alterarEndereco() {
            window.location.href = `cadastro-github.html?lojaid=${currentLojaId}&telefone=${encodeURIComponent(cliente.telefone)}`;
        }

        function voltar() {
            window.location.href = `pedido-github.html?lojaid=${currentLojaId}`;
        }

        async function enviarPedido() {
            hideError();

            const formaPagamento = document.getElementById('formaPagamento').value;
            const btnConfirmar = document.getElementById('btnConfirmar');

            if (!formaPagamento) {
                showError('Selecione a forma de pagamento');
                return;
            }

            btnConfirmar.disabled = true;
            btnConfirmar.textContent = 'â³ Enviando...';

            try {
                const codigoRastreio = gerarCodigoRastreio();
                const total = carrinho.reduce((soma, item) => soma + item.subtotal, 0);

                const pedidoData = {
                    cliente_telefone: cliente.telefone,
                    cliente_nome: cliente.nome,
                    cliente_endereco: tipoPedido === 'entrega' ? (cliente.endereco || '') : '',
                    garcom_id: 1,
                    tipo: tipoPedido,
                    status: 'novo',
                    total: total,
                    observacao: '',
                    taxa_entrega: 0,
                    codigo_rastreio: codigoRastreio,
                    lojaid: currentLojaId,
                    forma_pagamento: formaPagamento,
                    criado_em: new Date().toISOString(),
                    atualizado_em: new Date().toISOString()
                };

                const pedidoRef = await db.collection('pedidos').doc(codigoRastreio).set(pedidoData);

                const itensBatch = db.batch();
                for (const item of carrinho) {
                    const itemRef = db.collection('pedidos').doc(pedidoId).collection('itens').doc();
                    itensBatch.set(itemRef, {
                        produto_id: item.produto_id,
                        produto_nome: item.nome,
                        quantidade: item.quantidade,
                        preco_unitario: item.preco_unitario,
                        subtotal: item.subtotal
                    });
                }
                await itensBatch.commit();

                localStorage.removeItem(CARRINHO_KEY);
                localStorage.removeItem(TIPO_PEDIDO_KEY);

                showToast('Pedido enviado com sucesso! ğŸ‰', 'success');

                setTimeout(() => {
                    window.location.href = `meus-pedidos-github.html?lojaid=${currentLojaId}`;
                }, 2000);

            } catch (error) {
                console.error('Erro:', error);
                showError(error.message || 'Erro ao enviar pedido. Tente novamente.');
                btnConfirmar.disabled = false;
                btnConfirmar.textContent = 'âœ… Confirmar e Enviar Pedido';
            }
        }

        function gerarCodigoRastreio() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let codigo = '';
            for (let i = 0; i < 6; i++) {
                codigo += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return codigo;
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
