<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rastrear Pedido</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <div style="font-size: 48px;">ðŸ“¦</div>
            <h1>Rastrear Pedido</h1>
        </div>

        <form id="rastreioForm">
            <div class="form-group">
                <label class="form-label" for="codigo">CÃ³digo do Pedido</label>
                <input type="text" id="codigo" class="form-input" placeholder="Ex: ABC123" maxlength="8" style="text-transform: uppercase; text-align: center; font-size: 1.5rem; letter-spacing: 4px;" required>
            </div>
            <button type="submit" class="btn btn-primary" id="btnRastrear">Rastrear</button>
        </form>

        <div id="resultado" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <h2>ðŸ“‹ Pedido <span id="pedidoId"></span></h2>
                    <span id="statusBadge" class="badge"></span>
                </div>
                <div class="card-body">
                    <div class="status-timeline" id="statusTimeline"></div>
                    <div class="pedido-total">
                        <span>Total:</span>
                        <span id="pedidoTotal" style="font-weight: 700;"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="toast" id="toast" style="display: none;"></div>

    <script>
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyCh3E-Wu3OQZ8yZVxaRYdNNXVgmma4S8Jo",
            authDomain: "tocomfome-bbad8.firebaseapp.com",
            projectId: "tocomfome-bbad8",
            storageBucket: "tocomfome-bbad8.firebasestorage.app",
            messagingSenderId: "173195608514",
            appId: "1:173195608514:web:cf806076d52317bc58d65b"
        };

        let db = null;
        let app = null;
        let currentLojaId = null;

        function getLojaId() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('lojaid');
        }

        function showToast(mensagem, tipo = 'success') {
            const toast = document.getElementById('toast');
            if (toast) {
                toast.textContent = mensagem;
                toast.className = `toast ${tipo}`;
                toast.style.display = 'block';
                setTimeout(() => { toast.style.display = 'none'; }, 3000);
            }
        }

        function getStatusLabel(status) {
            const labels = { 'novo': 'Novo', 'confirmado': 'Confirmado', 'preparando': 'Preparando', 'saiu_entrega': 'Saiu para Entrega', 'entregue': 'Entregue', 'cancelado': 'Cancelado' };
            return labels[status] || status;
        }

        function getStatusColor(status) {
            const colors = { 'novo': '#f59e0b', 'confirmado': '#667eea', 'preparando': '#6366f1', 'saiu_entrega': '#4f46e5', 'entregue': '#10b981', 'cancelado': '#ef4444' };
            return colors[status] || '#666';
        }

        function formatarData(dataString) {
            if (!dataString) return '';
            const data = new Date(dataString);
            return data.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' });
        }

        async function initFirebase() {
            if (db) return db;
            try {
                app = firebase.initializeApp(FIREBASE_CONFIG);
                db = firebase.firestore();
                return db;
            } catch (error) {
                showToast('Erro ao conectar', 'error');
                return null;
            }
        }

        async function init() {
            currentLojaId = getLojaId();
            if (!currentLojaId) {
                showToast('Adicione ?lojaid=999 na URL', 'error');
                return;
            }
            await initFirebase();
        }

        async function rastrearPedido() {
            const codigo = document.getElementById('codigo').value.trim().toUpperCase();
            if (!codigo) { showToast('Digite o cÃ³digo'); return; }

            document.getElementById('btnRastrear').disabled = true;
            document.getElementById('btnRastrear').textContent = 'Buscando...';

            try {
                const doc = await db.collection(`pedidos_${currentLojaId}`).doc(codigo).get();
                if (!doc.exists) { showToast('Pedido nÃ£o encontrado'); }
                else {
                    const p = doc.data();
                    if (p.loja_id !== currentLojaId) {
                        showToast('Pedido nÃ£o encontrado nesta loja');
                    }
                    else {
                        document.getElementById('pedidoId').textContent = codigo;
                        document.getElementById('pedidoTotal').textContent = `R$ ${parseFloat(p.total || 0).toFixed(2).replace('.', ',')}`;
                        const badge = document.getElementById('statusBadge');
                        badge.textContent = getStatusLabel(p.status);
                        badge.style.background = getStatusColor(p.status);

                        const timeline = document.getElementById('statusTimeline');
                        const statusList = ['novo', 'confirmado', 'preparando', 'saiu_entrega', 'entregue'];
                        const currentIdx = statusList.indexOf(p.status);
                        timeline.innerHTML = statusList.map((s, i) => `
                            <div class="status-item ${i <= currentIdx ? 'active' : ''}" style="color: ${i <= currentIdx ? getStatusColor(s) : '#ccc'}">
                                <div class="status-dot">${i <= currentIdx ? 'âœ“' : 'â—‹'}</div>
                                <span>${getStatusLabel(s)}</span>
                            </div>
                        `).join('');

                        document.getElementById('resultado').style.display = 'block';
                    }
                }
            } catch (error) {
                showToast('Erro ao buscar pedido', 'error');
            } finally {
                document.getElementById('btnRastrear').disabled = false;
                document.getElementById('btnRastrear').textContent = 'Rastrear';
            }
        }

        document.getElementById('rastreioForm').addEventListener('submit', (e) => {
            e.preventDefault();
            rastrearPedido();
        });

        document.getElementById('codigo').addEventListener('input', function(e) {
            e.target.value = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
        });

        init();
    </script>
</body>
</html>
