<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rastrear Pedido - Sistema de Pedidos</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <div style="font-size: 48px; margin-bottom: 20px;">ğŸ“¦</div>
            <h1>Rastrear Pedido</h1>
            <p>Digite o cÃ³digo do pedido para acompanhar sem login</p>
        </div>

        <div class="error-message" id="errorMessage"></div>
        <div class="success-message" id="successMessage" style="display: none;"></div>

        <div id="rastreioFormContainer">
            <form id="rastreioForm">
                <div class="form-group">
                    <label class="form-label" for="codigo">CÃ³digo do Pedido</label>
                    <input 
                        type="text" 
                        id="codigo" 
                        class="form-input" 
                        placeholder="Ex: A1B2C3"
                        maxlength="6"
                        style="text-transform: uppercase; text-align: center; font-size: 1.5rem; letter-spacing: 4px;"
                        required
                    >
                    <p style="font-size: 0.875rem; color: var(--text-tertiary); margin-top: var(--spacing-sm);">
                        O cÃ³digo foi enviado no seu pedido
                    </p>
                </div>

                <button type="submit" class="btn btn-primary" id="btnRastrear">
                    Rastrear
                </button>
            </form>
        </div>

        <div id="resultadoRastreio" style="display: none;">
            <div class="card" style="margin-bottom: var(--spacing-lg);">
                <div class="card-header">
                    <h2>ğŸ“‹ Pedido <span id="pedidoId"></span></h2>
                </div>
                <div class="card-body">
                    <div style="margin-bottom: var(--spacing-md);">
                        <strong>Status:</strong> <span id="pedidoStatus" class="status-badge"></span>
                    </div>
                    <div style="margin-bottom: var(--spacing-md);">
                        <strong>Tipo:</strong> <span id="pedidoTipo"></span>
                    </div>
                    <div style="margin-bottom: var(--spacing-md);">
                        <strong>Total:</strong> <span id="pedidoTotal"></span>
                    </div>
                </div>
            </div>

            <div class="timeline">
                <div class="timeline-item" id="timeline-novo">
                    <div class="timeline-icon">ğŸ“</div>
                    <div class="timeline-content">
                        <strong>Pedido Recebido</strong>
                        <p>Seu pedido foi registrado</p>
                    </div>
                </div>
                <div class="timeline-item" id="timeline-preparando">
                    <div class="timeline-icon">ğŸ‘¨â€ğŸ³</div>
                    <div class="timeline-content">
                        <strong>Preparando</strong>
                        <p>Seu pedido estÃ¡ sendo preparado</p>
                    </div>
                </div>
                <div class="timeline-item" id="timeline-pronto">
                    <div class="timeline-icon">âœ…</div>
                    <div class="timeline-content">
                        <strong>Pronto</strong>
                        <p>Seu pedido estÃ¡ pronto</p>
                    </div>
                </div>
                <div class="timeline-item" id="timeline-saiu_entrega">
                    <div class="timeline-icon">ğŸšš</div>
                    <div class="timeline-content">
                        <strong>Saiu para Entrega</strong>
                        <p>Pedido a caminho</p>
                    </div>
                </div>
                <div class="timeline-item" id="timeline-entregue">
                    <div class="timeline-icon">ğŸ</div>
                    <div class="timeline-content">
                        <strong>Entregue</strong>
                        <p>Pedido entregue ao cliente</p>
                    </div>
                </div>
            </div>

            <div id="botaoConfirmarEntrega" style="display: none; margin-top: var(--spacing-lg);">
                <button class="btn btn-success btn-lg" onclick="confirmarEntrega()" style="width: 100%;">
                    âœ… Confirmar que recebi o pedido
                </button>
            </div>

            <button class="btn btn-secondary" onclick="limparRastreio()" style="margin-top: var(--spacing-lg); width: 100%;">
                Nova Busca
            </button>
        </div>

        <div style="margin-top: var(--spacing-xl); padding-top: var(--spacing-lg); border-top: 1px solid var(--border-light); text-align: center;">
            <p style="font-size: 0.875rem; color: var(--text-tertiary); margin-bottom: var(--spacing-sm);">
                JÃ¡ tem cadastro?
            </p>
            <a href="telefone.html" class="btn btn-primary" style="max-width: 200px; margin: 0 auto;">
                ğŸ” Login
            </a>
        </div>
    </div>

    <div class="toast" id="toast" style="display: none;"></div>

    <script src="app.js"></script>
    <script>
        let pedidoAtual = null;

        document.addEventListener('DOMContentLoaded', () => {
            const cliente = getCliente();
            
            if (cliente && cliente.telefone) {
                window.location.href = 'meus-pedidos.html';
                return;
            }
            
            document.getElementById('rastreioForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const codigo = document.getElementById('codigo').value.trim().toUpperCase();
                const btn = document.getElementById('btnRastrear');
                const errorEl = document.getElementById('errorMessage');
                
                errorEl.style.display = 'none';
                
                if (codigo.length !== 6) {
                    showError('Digite o cÃ³digo completo (6 dÃ­gitos)');
                    return;
                }
                
                btn.disabled = true;
                btn.textContent = 'Buscando...';
                
                try {
                    const response = await fetch(`/api/public/pedidos/rastreio/${encodeURIComponent(codigo)}`);
                    const data = await response.json();
                    
                    if (response.ok && data.pedido) {
                        pedidoAtual = data.pedido;
                        mostrarResultado(data.pedido);
                    } else {
                        showError(data.error || 'Pedido nÃ£o encontrado. Verifique o cÃ³digo e tente novamente.');
                    }
                } catch (error) {
                    console.error('Erro:', error);
                    showError('Erro ao buscar pedido. Tente novamente.');
                } finally {
                    btn.disabled = false;
                    btn.textContent = 'Rastrear';
                }
            });

            function mostrarResultado(pedido) {
                document.getElementById('rastreioFormContainer').style.display = 'none';
                document.getElementById('resultadoRastreio').style.display = 'block';
                
                document.getElementById('pedidoId').textContent = pedido.id;
                document.getElementById('pedidoStatus').textContent = formatarStatus(pedido.status);
                document.getElementById('pedidoStatus').className = `status-badge status-${pedido.status}`;
                document.getElementById('pedidoTipo').textContent = formatarTipo(pedido.tipo);
                document.getElementById('pedidoTotal').textContent = formatarMoeda(pedido.total);
                
                atualizarTimeline(pedido.status);
                
                // Mostrar botÃ£o de confirmar entrega apenas se status for "saiu_entrega"
                const btnConfirmar = document.getElementById('botaoConfirmarEntrega');
                if (pedido.status === 'saiu_entrega') {
                    btnConfirmar.style.display = 'block';
                } else {
                    btnConfirmar.style.display = 'none';
                }
            }

            async function confirmarEntrega() {
                if (!pedidoAtual || pedidoAtual.status !== 'saiu_entrega') {
                    showError('NÃ£o Ã© possÃ­vel confirmar entrega neste momento.');
                    return;
                }
                
                const btn = document.getElementById('botaoConfirmarEntrega').querySelector('button');
                btn.disabled = true;
                btn.textContent = 'Confirmando...';
                
                try {
                    const response = await fetch(`/api/public/pedidos/${pedidoAtual.id}/entregue`, {
                        method: 'POST'
                    });
                    const data = await response.json();
                    
                    if (response.ok && data.success) {
                        showToast('Entrega confirmada com sucesso!', 'success');
                        pedidoAtual.status = 'entregue';
                        document.getElementById('pedidoStatus').textContent = formatarStatus('entregue');
                        document.getElementById('pedidoStatus').className = 'status-badge status-entregue';
                        atualizarTimeline('entregue');
                        document.getElementById('botaoConfirmarEntrega').style.display = 'none';
                    } else {
                        showError(data.error || 'Erro ao confirmar entrega.');
                    }
                } catch (error) {
                    console.error('Erro:', error);
                    showError('Erro ao confirmar entrega. Tente novamente.');
                } finally {
                    btn.disabled = false;
                    btn.textContent = 'âœ… Confirmar que recebi o pedido';
                }
            }

            function atualizarTimeline(status) {
                const statusOrdem = ['novo', 'preparando', 'pronto', 'saiu_entrega', 'entregue'];
                const statusIndex = statusOrdem.indexOf(status);
                
                document.querySelectorAll('.timeline-item').forEach(item => {
                    item.classList.remove('active', 'completed');
                });
                
                let i = 0;
                for (; i <= statusIndex && i < statusOrdem.length; i++) {
                    const item = document.getElementById(`timeline-${statusOrdem[i]}`);
                    if (item) item.classList.add('completed');
                }
                
                const currentItem = document.getElementById(`timeline-${status}`);
                if (currentItem && status !== 'entregue') {
                    currentItem.classList.add('active');
                }
            }

            function limparRastreio() {
                document.getElementById('rastreioForm').reset();
                document.getElementById('rastreioFormContainer').style.display = 'block';
                document.getElementById('resultadoRastreio').style.display = 'none';
            }

            function formatarStatus(status) {
                const statusMap = {
                    'novo': 'Recebido',
                    'preparando': 'Preparando',
                    'pronto': 'Pronto',
                    'saiu_entrega': 'Saiu para Entrega',
                    'entregue': 'Entregue'
                };
                return statusMap[status] || status;
            }

            function formatarTipo(tipo) {
                const tipoMap = {
                    'mesa': 'Mesa',
                    'balcao': 'BalcÃ£o',
                    'entrega': 'Delivery',
                    'retirada': 'Retirada'
                };
                return tipoMap[tipo] || tipo;
            }
        });
    </script>
</body>
</html>
